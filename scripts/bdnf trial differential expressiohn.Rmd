```{r setup}
knitr::opts_chunk$set(echo = TRUE)
if (!require("pacman")){
    install.packages("pacman")
} #if pacman is not installed, install it
pacman::p_load(tidyverse, data.table, ggplot2, janitor, ggpubr, ggrepel,
               devtools, readxl, DESeq2, readr, edgeR, annotables)
if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
library(PCAtools)
library(clusterProfiler)
library(org.Hs.eg.db)
```

this let's you access the necessary functions, gifted by AL :)
```{r}
source(here::here('create_feature_count_table.R'))
source(here::here('make_deseq_dfs.R'))
source(here::here('run_standard_deseq.R'))
source(here::here('make_volcano_plot.R'))
```

this organizes all the data from the many .bam files and creates one data frame you can work with
```{r}
featureCounts <- create_feature_count_table("/Users/matteozanovello/Documents/phd/research_lines/splicing_chx/data/feature_count")
```

this runs the make_deseq_dfs() function
```{r}
my_df <- make_deseq_dfs(featureCounts, grep_pattern = "", base_grep = "CTRL_chx", contrast_grep = "DOX_chx")
```

running run_standard_deseq
```{r}
my.dds <- run_standard_deseq("/Users/matteozanovello/Documents/phd/research_lines/splicing_chx/data/feature_count", 
                             base_grep = "CTRL_chx",
                             contrast_grep = "DOX_chx",  
                             grep_pattern = "",
                             baseName = "CycloheximideControl",
                             contrastName = 'CycloheximideTDP43KD')
```

running it to make preeeettttyyyy graph
```{r}
make_volcano_plot(my.dds$results_table)
```
This is the vignette for the PCAtools package
https://bioconductor.org/packages/release/bioc/vignettes/PCAtools/inst/doc/PCAtools.html

We're going to put the "ensgene" into a 'rowname' and then do the PCA analysis.
Now I'm going to write this using the pipe operator "%>%". Your "hot key" to type that in is: Ctrl + Shift + M
```{r}
bdnf_counts <- featureCounts[,1:9] # so that you exclude the "gene name" column
colnames(bdnf_counts) <- c("ensgene", "CTRL_chx_1", "CTRL_chx_2", "CTRL_chx_3", "CTRL_chx_4",
                           "DOX_chx_1", "DOX_chx_2", "DOX_chx_3", "DOX_chx_4")

pca <- bdnf_counts %>% 
    column_to_rownames('ensgene') #%>% t()
```

So let's do a PCA plot using meta data
```{r}
path_to_meta_you_downloaded <-  "/Users/matteozanovello/Documents/phd/research_lines/splicing_chx/data/metadata.csv" #update this
meta_df <- fread(path_to_meta_you_downloaded)
meta_df <- meta_df %>% 
    column_to_rownames('sample') 

p <- PCAtools::pca(pca, metadata = meta_df, removeVar = 0.1)
```

As before the screeplot
```{r}
screeplot(p, axisLabSize = 18, titleLabSize = 22)
```

Now we're going to make what is called an "eigencorplot"
This is going to correlate our metadata variables with our principle components. 
```{r}
#PCAtools::eigencorplot(p, components = getComponents(p),
#                       metavars = c('condition',"treatment"))
```

We can do a biplot with the 2 PC's that are correlating
```{r}
biplot(p,
       x = "PC1",
       y = "PC2",
       colby = 'condition')
```

Let's go ahead and find out what the genes are that are correlated with PC1.
Let's directly take the loadings of each of the genes (a PCA is a linear combination). 

I'm going to also show you now how to put the symbol back on the table. 
We shall use the wonder of the `left_join`
```{r}
pc1_gene_loadings = p$loadings %>% 
    dplyr::select(PC1) %>% 
    rownames_to_column('ensgene') %>% 
    left_join(annotables::grch38 %>% dplyr::select(ensgene)) %>% 
#https://statisticsglobe.com/r-dplyr-join-inner-left-right-full-semi-anti
    arrange(-PC1)
```

Now we've seen a join let's do the same thing with our original count table
```{r}
bdnf_counter = bdnf_counts %>% 
    left_join(annotables::grch38 %>% dplyr::select(ensgene))
```

I want to look at the expression of the top 15 genes on PC1 so I'm going 
to plot their expression.
```{r}
bdnf_counter %>% 
    left_join(pc1_gene_loadings %>% head(15)) %>%
    filter(!is.na(PC1)) %>%
    #dplyr::select(-ensgene) %>% 
    melt(id.vars = c("ensgene","PC1")) %>%
    mutate(ensgene = fct_reorder(ensgene,-PC1)) %>% 
    separate(variable, into = c("condition","treatment")) %>%
ggplot(aes(x = treatment, y = value, fill = condition)) + 
    geom_col(position = "dodge2") + facet_wrap(~ensgene)

```

GO analysis
```{r}
results <- my.dds$results_table
filtered_res <- filter(results, padj < 0.1 )
ordered_res <- arrange(filtered_res, desc(abs(log2FoldChange)))

gene <- ordered_res$gene_name[abs(ordered_res$log2FoldChange) > 2]

ggo <- groupGO(gene = gene,
               OrgDb = org.Hs.eg.db,
               keyType = "SYMBOL",
               ont = "CC",
               level = 3)

ego <- enrichGO(gene = gene,
                keyType = "SYMBOL",
                OrgDb = org.Hs.eg.db,
                ont = "CC",
                pAdjustMethod = "BH",
                pvalueCutoff = 0.01,
                qvalueCutoff = 0.05)
```